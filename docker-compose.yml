version: '3.8'

services:
  db:
    image: pgvector/pgvector:pg16
    container_name: biometry-db
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: biometry_db
    volumes:
      - db-data:/var/lib/postgresql/data
      - ./migrations:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d biometry_db"]
      interval: 5s
      timeout: 3s
      retries: 20

  vision-worker:
    build: .
    image: identification-rust-base:latest
    container_name: vision-worker
    working_dir: /workspace/identification
    command: ["bash", "-lc", "cargo run -p vision-worker"]
    ports:
      - "50052:50052"
    volumes:
      - .:/workspace/identification
      - cargo-registry:/usr/local/cargo/registry
      - cargo-git:/usr/local/cargo/git
      # КРИТИЧНО: изолируем target, чтобы не было конфликта glibc 
      - target-cache-vision:/workspace/identification/target
    environment:
      RUST_LOG: "${RUST_LOG:-vision_worker=info,ort::logging=warn}"
      VISION_FORCE_CPU: "${VISION_FORCE_CPU:-0}"
      VISION_CUDA_MEM_LIMIT_MB: "${VISION_CUDA_MEM_LIMIT_MB:-1536}"
      NVIDIA_VISIBLE_DEVICES: all
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    depends_on:
      db:
        condition: service_healthy

  audio-worker:
    build: .
    image: identification-rust-base:latest
    container_name: audio-worker
    working_dir: /workspace/identification
    command: ["bash", "-lc", "cargo run -p audio-worker"]
    ports:
      - "50053:50053"
    volumes:
      - .:/workspace/identification
      - cargo-registry:/usr/local/cargo/registry
      - cargo-git:/usr/local/cargo/git
      - target-cache-audio:/workspace/identification/target
    environment:
      RUST_LOG: "${RUST_LOG:-audio_worker=info,ort::logging=warn}"
      AUDIO_USE_CUDA: "${AUDIO_USE_CUDA:-1}"
      AUDIO_CUDA_MEM_LIMIT_MB: "${AUDIO_CUDA_MEM_LIMIT_MB:-256}"
      NVIDIA_VISIBLE_DEVICES: all
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    depends_on:
      db:
        condition: service_healthy

  gateway-service:
    build: .
    image: identification-rust-base:latest
    container_name: gateway-service
    working_dir: /workspace/identification
    command: ["bash", "-lc", "cargo run -p gateway-service"]
    ports:
      - "50051:50051"
    volumes:
      - .:/workspace/identification
      - cargo-registry:/usr/local/cargo/registry
      - target-cache-gateway:/workspace/identification/target
    environment:
      DATABASE_URL: "postgres://user:password@db:5432/biometry_db"
      AUDIO_URL: "http://audio-worker:50053"
      VISION_URL: "http://vision-worker:50052"
    depends_on:
      db:
        condition: service_healthy
      audio-worker:
        condition: service_started
      vision-worker:
        condition: service_started

volumes:
  db-data:
  cargo-registry:
  cargo-git:
  # Раздельные volume для каждого сервиса ускоряют параллельную сборку
  target-cache-vision:
  target-cache-audio:
  target-cache-gateway: